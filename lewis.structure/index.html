<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lewis Structure Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --atom-size: 54px;
            --bond-width: 14px;
            --grid-size: 60px;
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #ffffff;
            font-family: 'Inter', system-ui, sans-serif;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background-color: #ffffff;
            /* Subtle grid background */
            background-image: 
                radial-gradient(circle, #e2e8f0 1.5px, transparent 1.5px);
            background-size: var(--grid-size) var(--grid-size);
            background-position: center center;
            overflow: hidden;
            touch-action: none;
        }
        .atom {
            position: absolute;
            width: var(--atom-size);
            height: var(--atom-size);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: white;
            cursor: pointer;
            user-select: none;
            z-index: 30;
            border: 3px solid #000000;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease, left 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275), top 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.25rem;
        }
        /* Disable transition during active dragging for responsiveness */
        .atom.dragging { 
            cursor: grabbing; 
            scale: 1.1; 
            z-index: 40; 
            transition: transform 0.1s ease; 
        }
        
        svg#bond-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .bond-hitbox {
            cursor: pointer;
            pointer-events: all;
            stroke: transparent;
            stroke-width: 30;
            fill: none;
        }

        .lone-pair-dot {
            position: absolute;
            width: 7px;
            height: 7px;
            background: #000000;
            border-radius: 50%;
            pointer-events: none;
            z-index: 25;
            transform: translate(-50%, -50%);
            transition: left 0.15s ease, top 0.15s ease;
        }

        .tool-panel {
            @apply bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm z-50;
        }
        
        .element-chip {
            width: var(--atom-size);
            height: var(--atom-size);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: white;
            cursor: pointer;
            user-select: none;
            border: 3px solid #000000;
            transition: transform 0.1s ease;
            font-size: 1.25rem;
            box-sizing: border-box;
        }
        
        .element-chip.active {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5);
            z-index: 60;
        }

        .palette-container {
            @apply flex flex-col items-center gap-1;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="tool-panel">
            <div class="flex items-center gap-10">
                <div class="flex items-center gap-2">
                    <div class="bg-black p-2 rounded-xl text-white">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="8"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg>
                    </div>
                    <span class="font-black text-slate-900 tracking-tight text-xl uppercase hidden sm:inline">Lewis Builder</span>
                </div>
                
                <div id="element-palette" class="flex gap-4 border-l-2 pl-10 border-slate-200">
                    <!-- Atoms generated by JS -->
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-slate-200 p-1 rounded-2xl">
                    <button onclick="setMode('select')" id="mode-select" class="px-5 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-blue-600">Place/Move</button>
                    <button onclick="setMode('erase')" id="mode-erase" class="px-5 py-2 rounded-xl text-sm font-bold transition-all text-slate-600">Eraser</button>
                </div>
                <button onclick="checkStructure()" class="bg-black text-white px-6 py-2 rounded-2xl font-bold hover:bg-slate-800 transition-all active:scale-95">Verify</button>
                <button onclick="resetCanvas()" class="text-slate-400 hover:text-red-500 transition-all p-2">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
            </div>
        </header>

        <div id="canvas-container">
            <svg id="bond-svg"></svg>
        </div>

        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 bg-slate-900 text-white rounded-3xl shadow-2xl opacity-0 transition-all translate-y-4 pointer-events-none flex items-center gap-4 z-[100]">
            <span id="toast-icon" class="text-xl"></span>
            <span id="toast-msg" class="font-bold text-sm tracking-wide"></span>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas-container');
        const bondSvg = document.getElementById('bond-svg');
        const GRID_SIZE = 60;
        
        let atoms = [];
        let bonds = [];
        let currentMode = 'select'; 
        let activeSymbol = 'C';
        
        let dragSourceAtom = null;
        let isDragging = false;
        let hasMoved = false;
        let mouseDownPos = { x: 0, y: 0 };
        let currentMousePos = { x: 0, y: 0 };

        const elements = {
            'H': { color: '#a1a1aa', valence: 1, octet: 2 },
            'C': { color: '#18181b', valence: 4, octet: 8 },
            'N': { color: '#2563eb', valence: 5, octet: 8 },
            'O': { color: '#b91c1c', valence: 6, octet: 8 },
            'F': { color: '#d97706', valence: 7, octet: 8 },
            'Cl': { color: '#059669', valence: 7, octet: 8 }
        };

        function getSnappedCoord(val) {
            // Find center of canvas to align grid properly
            const rect = canvas.getBoundingClientRect();
            const centerOffset = {
                x: (rect.width / 2) % GRID_SIZE,
                y: (rect.height / 2) % GRID_SIZE
            };
            return Math.round((val - centerOffset.x) / GRID_SIZE) * GRID_SIZE + centerOffset.x;
        }

        function init() {
            const palette = document.getElementById('element-palette');
            palette.innerHTML = '';
            Object.keys(elements).forEach(sym => {
                const container = document.createElement('div');
                container.className = 'palette-container';
                const div = document.createElement('div');
                div.className = `element-chip ${sym === activeSymbol ? 'active' : ''}`;
                div.style.backgroundColor = elements[sym].color;
                div.innerText = sym;
                div.onclick = () => {
                    activeSymbol = sym;
                    document.querySelectorAll('.element-chip').forEach(c => {
                        c.classList.toggle('active', c.innerText === sym);
                    });
                };
                container.appendChild(div);
                palette.appendChild(container);
            });
            render();
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('mode-select').className = m === 'select' ? 'px-5 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-blue-600' : 'px-5 py-2 rounded-xl text-sm font-bold transition-all text-slate-600';
            document.getElementById('mode-erase').className = m === 'erase' ? 'px-5 py-2 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-red-600' : 'px-5 py-2 rounded-xl text-sm font-bold transition-all text-slate-600';
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const rawX = e.clientX - rect.left;
            const rawY = e.clientY - rect.top;
            mouseDownPos = { x: rawX, y: rawY };
            currentMousePos = { ...mouseDownPos };

            const hitAtom = findAtomAt(rawX, rawY);
            
            if (hitAtom) {
                dragSourceAtom = hitAtom;
                isDragging = true;
                hasMoved = false;
            } else if (e.target === canvas && currentMode === 'select') {
                const snappedX = getSnappedCoord(rawX);
                const snappedY = getSnappedCoord(rawY);
                // Check if space is already occupied
                if (!findAtomAt(snappedX, snappedY)) {
                    atoms.push({ id: Date.now(), symbol: activeSymbol, x: snappedX, y: snappedY, lonePairs: 0 });
                }
                render();
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = canvas.getBoundingClientRect();
            currentMousePos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
            
            const dx = currentMousePos.x - mouseDownPos.x;
            const dy = currentMousePos.y - mouseDownPos.y;
            if (Math.sqrt(dx*dx + dy*dy) > 10) hasMoved = true;

            if (hasMoved) {
                // If holding modifiers, we move the atom instead of drawing a bond
                if (e.shiftKey || e.altKey || e.ctrlKey) {
                    dragSourceAtom.x = getSnappedCoord(currentMousePos.x);
                    dragSourceAtom.y = getSnappedCoord(currentMousePos.y);
                }
                render();
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            
            if (!hasMoved) {
                // Handle single clicks
                if (currentMode === 'erase') {
                    deleteAtom(dragSourceAtom.id);
                } else {
                    dragSourceAtom.lonePairs = (dragSourceAtom.lonePairs + 1) % 5;
                }
            } else {
                // Handle drags (bond creation or move completion)
                if (e.shiftKey || e.altKey || e.ctrlKey) {
                    // Atom already moved in mousemove
                    dragSourceAtom.x = getSnappedCoord(currentMousePos.x);
                    dragSourceAtom.y = getSnappedCoord(currentMousePos.y);
                } else {
                    // Bond creation
                    const targetAtom = findAtomAt(currentMousePos.x, currentMousePos.y);
                    if (targetAtom && targetAtom.id !== dragSourceAtom.id) {
                        addOrCycleBond(dragSourceAtom.id, targetAtom.id);
                    }
                }
            }
            
            isDragging = false;
            dragSourceAtom = null;
            render();
        });

        function findAtomAt(x, y) {
            // Check if coordinates are within atom radius (27px)
            return atoms.find(a => Math.sqrt((a.x-x)**2 + (a.y-y)**2) < 27);
        }

        function deleteAtom(id) {
            atoms = atoms.filter(a => a.id !== id);
            bonds = bonds.filter(b => b.a !== id && b.b !== id);
        }

        function addOrCycleBond(id1, id2) {
            const existing = bonds.find(b => (b.a === id1 && b.b === id2) || (b.a === id2 && b.b === id1));
            if (existing) existing.type = (existing.type % 3) + 1;
            else bonds.push({ a: id1, b: id2, type: 1 });
        }

        function render() {
            bondSvg.innerHTML = '';
            document.querySelectorAll('.atom, .lone-pair-dot').forEach(el => el.remove());

            // Draw Bonds
            bonds.forEach(bond => {
                const a1 = atoms.find(a => a.id === bond.a);
                const a2 = atoms.find(a => a.id === bond.b);
                if (a1 && a2) {
                    drawBond(a1, a2, bond.type, '#d1d5db', 14);
                    const hit = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    hit.setAttribute('x1', a1.x); hit.setAttribute('y1', a1.y);
                    hit.setAttribute('x2', a2.x); hit.setAttribute('y2', a2.y);
                    hit.setAttribute('class', 'bond-hitbox');
                    hit.onclick = (e) => {
                        e.stopPropagation();
                        if (currentMode === 'erase') bonds = bonds.filter(b => b !== bond);
                        else bond.type = (bond.type % 3) + 1;
                        render();
                    };
                    bondSvg.appendChild(hit);
                }
            });

            // Draw Bond Preview (Dragging)
            if (isDragging && hasMoved && dragSourceAtom && !window.event?.shiftKey && !window.event?.ctrlKey && !window.event?.altKey) {
                const target = findAtomAt(currentMousePos.x, currentMousePos.y);
                const end = target ? { x: target.x, y: target.y } : currentMousePos;
                drawBond(dragSourceAtom, end, 1, '#cbd5e1', 14, true);
            }

            // Draw Atoms
            atoms.forEach(atom => {
                const div = document.createElement('div');
                div.className = `atom ${dragSourceAtom?.id === atom.id && isDragging ? 'dragging' : ''}`;
                div.style.left = `${atom.x}px`;
                div.style.top = `${atom.y}px`;
                div.style.backgroundColor = elements[atom.symbol].color;
                div.innerText = atom.symbol;
                canvas.appendChild(div);

                // Draw Lone Pairs
                for (let i = 0; i < atom.lonePairs; i++) {
                    const angle = (i * 90) * (Math.PI / 180);
                    const radius = 28;
                    [-5, 5].forEach(offset => {
                        const dot = document.createElement('div');
                        dot.className = 'lone-pair-dot';
                        dot.style.left = `${atom.x + Math.cos(angle) * radius + Math.cos(angle + Math.PI/2) * offset}px`;
                        dot.style.top = `${atom.y + Math.sin(angle) * radius + Math.sin(angle + Math.PI/2) * offset}px`;
                        canvas.appendChild(dot);
                    });
                }
            });
        }

        function drawBond(a1, a2, type, color, width, isPreview = false) {
            const dx = a2.x - a1.x;
            const dy = a2.y - a1.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 10) return;

            const offsets = type === 1 ? [0] : (type === 2 ? [-7, 7] : [-10, 0, 10]);
            offsets.forEach(offset => {
                const ox = (-dy / dist) * offset;
                const oy = (dx / dist) * offset;
                
                const outline = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                outline.setAttribute('x1', a1.x + ox);
                outline.setAttribute('y1', a1.y + oy);
                outline.setAttribute('x2', a2.x + ox);
                outline.setAttribute('y2', a2.y + oy);
                outline.setAttribute('stroke', '#000000');
                outline.setAttribute('stroke-width', width + 4);
                outline.setAttribute('stroke-linecap', 'butt');
                if (isPreview) outline.setAttribute('stroke-dasharray', '5 5');
                bondSvg.appendChild(outline);

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', a1.x + ox);
                line.setAttribute('y1', a1.y + oy);
                line.setAttribute('x2', a2.x + ox);
                line.setAttribute('y2', a2.y + oy);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', width);
                line.setAttribute('stroke-linecap', 'butt');
                if (isPreview) line.setAttribute('stroke-dasharray', '5 5');
                bondSvg.appendChild(line);
            });
        }

        function checkStructure() {
            if (atoms.length === 0) return;
            let errors = [];
            atoms.forEach(a => {
                const bValence = bonds.filter(b => b.a === a.id || b.b === a.id).reduce((s, b) => s + b.type, 0);
                const totalElectrons = (a.lonePairs * 2) + (bValence * 2);
                if (totalElectrons !== elements[a.symbol].octet) errors.push(a.symbol);
            });
            if (errors.length === 0) showToast("Perfect! All octets satisfied.", "✨");
            else showToast(`Check octets for: ${[...new Set(errors)].join(', ')}`, "⚠️");
        }

        function showToast(msg, icon) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerText = icon;
            t.classList.remove('opacity-0', 'translate-y-4');
            t.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-4');
                t.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        function resetCanvas() { atoms = []; bonds = []; render(); }

        init();
    </script>
</body>
</html>
